<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (Money Tracker)</title>
    <!-- ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÅ‡∏•‡∏∞ Responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ‡πÇ‡∏´‡∏•‡∏î SweetAlert2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- ‡πÇ‡∏´‡∏•‡∏î Chart.js ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- ‡πÇ‡∏´‡∏•‡∏î Chart.js DataLabels Plugin ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏ô‡πÅ‡∏ó‡πà‡∏á‡∏Å‡∏£‡∏≤‡∏ü -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+Thai:wght@100..900&display=swap');
        body {
            font-family: 'Noto Sans Thai', 'Inter', sans-serif;
            background-color: #f7fdee; /* Lightest emerald/mint green background */
        }
        /* Custom scrollbar style for better aesthetics */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #4ade80; /* Light emerald for thumb */
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #e6f7e9; /* Even lighter track */
        }

        /* Styling for the main content tabs */
        .main-tab {
            padding: 10px 20px;
            border-radius: 12px 12px 0 0;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        .main-tab:hover {
            background-color: #d1fae5;
        }
        .active-main-tab {
            background-color: #ecfdf5;
            border-bottom: 2px solid #059669; /* Deep emerald underline */
            color: #059669;
            font-weight: 700;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Global State & Config -->
    <script>
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î URL ‡∏Ç‡∏≠‡∏á Google App Script ‡∏ó‡∏µ‡πà Deploy ‡πÅ‡∏•‡πâ‡∏ß - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxKoilorOY7go2Te9SlD5xkcQpADaAuYqmCa3k4YF6fuYUVSE-iqg1dWeiwZCTB9y22lw/exec";
        
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
        const USERS = [
            { name: "sek", password: "154654" },
            { name: "arm", password: "154654" }
        ];

        // ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
        const CATEGORIES = {
            '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö': [
                '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Salary)', 
                '‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Other Sources)', 
                '‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏±‡∏ô‡∏ú‡∏•/‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (Dividends/Interest)',
                '‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô (Investment Return)', 
                '‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á (Sales)', 
                '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Others)', 
                '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Notes)'
            ],
            '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢': [
                '‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (Food)', 
                '‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ/‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á (Supplies/Shopping)', 
                '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á (Entertainment)', 
                '‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏£‡∏ñ (Car Payment)', 
                '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô (Fuel)', 
                '‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å (Child Expenses)', 
                '‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏Ø (Credit Card Payment)', 
                '‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á (Travel)',
                '‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å/‡∏ú‡πà‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô (Housing/Rent)',
                '‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ (Utilities)',
                '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Others)', 
                '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Notes)'
            ]
        };
        
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        let isLoggedIn = false;
        let records = []; // All records loaded from Sheet
        let allCharts = {};
        let currentPeriod = 'daily'; // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Summary View
        let selectedMonthYear = ''; // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ('YYYY-MM')
        let selectedYear = new Date().getFullYear().toString(); // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ('YYYY')
        let currentView = 'summary'; // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: 'summary', 'dashboard' ‡∏´‡∏£‡∏∑‡∏≠ 'records'

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
        const CHART_COLORS = [
            '#34d399', '#facc15', '#60a5fa', '#f472b6', '#3b82f6', 
            '#ef4444', '#f97316', '#a855f7', '#14b8a6', '#6366f1'
        ];
        const PRIMARY_COLOR = '#059669'; // Emerald
        const SECONDARY_COLOR = '#ef4444'; // Red

    </script>

    <!-- UI Implementation -->

    <div id="login-screen" class="fixed inset-0 bg-emerald-50 flex items-center justify-center p-4 z-50 transition-opacity duration-500">
        <div class="w-full max-w-sm bg-white p-8 rounded-xl shadow-2xl border border-emerald-200">
            <div class="text-center mb-6">
                <!-- Logo: International Currency -->
                <div class="text-6xl mb-2">üåçüí∞</div>
                <h1 class="text-3xl font-extrabold text-emerald-700">Money Tracker</h1>
                <p class="text-gray-500 mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</p>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Name)</label>
                    <input type="text" id="username" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:border-emerald-500 focus:ring-emerald-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)</label>
                    <input type="password" id="password" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:border-emerald-500 focus:ring-emerald-500" required>
                </div>
                <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2.5 rounded-lg transition duration-150 ease-in-out shadow-lg shadow-emerald-200">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </form>
        </div>
    </div>

    <div id="main-app" class="hidden flex-grow md:flex md:flex-row">
        <!-- Sidebar / Main Form (Mobile Top / Desktop Left) -->
        <div class="w-full md:w-1/3 p-4 md:p-6 lg:p-8 bg-emerald-50 border-r border-emerald-200">
            <div class="sticky top-0 pb-4 md:pb-0">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <!-- ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà: üìù (Memo/Note) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -->
                        <div class="text-4xl mr-2">üìù</div>
                        <h2 class="text-2xl font-bold text-emerald-800">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà</h2>
                    </div>
                    <button onclick="logout()" class="text-sm text-red-500 hover:text-red-700 font-medium transition duration-150">
                        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (<span id="current-user"></span>)
                    </button>
                </div>
                
                <!-- Entry Form Card -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-emerald-100">
                    <form id="record-form">
                        <input type="hidden" id="record-id">
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                            <select id="type" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500" required>
                                <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Select Type)</option>
                                <option value="‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (Income)</option>
                                <option value="‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (Expense)</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="category" class="block text-sm font-medium text-gray-700">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                            <select id="category" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500" required disabled>
                                <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡πà‡∏≠‡∏ô</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="amount" class="block text-sm font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" id="amount" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" required min="0">
                        </div>

                        <div class="mb-6">
                            <label for="datetime-input" class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤ (‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ)</label>
                            <input type="datetime-local" id="datetime-input" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500" required>
                        </div>
                        
                        <button type="submit" id="save-button" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg transition duration-150 ease-in-out shadow-md shadow-emerald-300">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="w-full md:w-2/3 p-4 md:p-6 lg:p-8 flex flex-col space-y-4 custom-scroll overflow-y-auto">
            
            <!-- Tab Navigation (UPDATED) -->
            <div class="flex border-b border-gray-200">
                <button id="tab-summary" class="main-tab active-main-tab" onclick="showView('summary')">
                    üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </button>
                <button id="tab-dashboard" class="main-tab" onclick="showView('dashboard')">
                    üìà ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
                </button>
                <button id="tab-records" class="main-tab" onclick="showView('records')">
                    üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                </button>
            </div>

            <!-- Summary View (Existing content - REMOVED RECENT RECORDS SECTION) -->
            <div id="summary-view" class="space-y-8">
                
                <!-- Summary Section -->
                <div id="summary-section" class="space-y-6 pt-4">
                    <!-- Title Section -->
                    <div class="flex items-end justify-between border-b pb-2 border-emerald-200">
                        <h2 class="text-2xl font-bold text-emerald-800">‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h2>
                        <span id="summary-title-period" class="text-lg font-medium text-gray-600 mb-0.5"></span>
                    </div>
                    
                    <!-- Time Range Tabs -->
                    <div class="flex flex-wrap gap-2 text-sm font-medium text-gray-700">
                        <button class="time-tab active-tab" data-period="daily">‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
                        <button class="time-tab" data-period="weekly">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</button>
                        <button class="time-tab" data-period="monthly">‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
                        <button class="time-tab" data-period="yearly">‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏µ</button>
                    </div>

                    <!-- Month Selector Container (Hidden by default, shown for 'monthly' tab) -->
                    <div id="month-selector-container" class="hidden">
                        <label for="month-selector" class="block text-sm font-semibold text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ:</label>
                        <select id="month-selector" class="w-full md:w-1/3 p-2 border border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500 shadow-sm"></select>
                    </div>
                    
                    <!-- Year Selector Container (Hidden by default, shown for 'yearly' tab) -->
                    <div id="year-selector-container" class="hidden">
                        <label for="year-selector" class="block text-sm font-semibold text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ:</label>
                        <select id="year-selector" class="w-full md:w-1/3 p-2 border border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-emerald-500 shadow-sm"></select>
                    </div>

                    <style>
                        .time-tab {
                            padding: 8px 16px;
                            border-radius: 9999px; /* Full rounded */
                            border: 1px solid #d1fae5; /* Light emerald border */
                            background-color: #ecfdf5; /* Very light emerald bg */
                            transition: all 0.2s;
                        }
                        .time-tab:hover {
                            background-color: #d1fae5;
                        }
                        .active-tab {
                            background-color: #059669; /* Deep emerald */
                            color: white;
                            border-color: #059669;
                            font-weight: 600;
                        }
                    </style>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-5 rounded-xl shadow-lg border-l-4 border-emerald-500">
                            <p class="text-sm text-gray-500">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</p>
                            <p id="summary-income" class="text-2xl font-extrabold text-emerald-600 mt-1">0.00</p>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-lg border-l-4 border-red-500">
                            <p class="text-sm text-gray-500">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</p>
                            <p id="summary-expense" class="text-2xl font-extrabold text-red-600 mt-1">0.00</p>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-lg border-l-4 border-blue-500">
                            <p class="text-sm text-gray-500">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</p>
                            <p id="summary-net" class="text-2xl font-extrabold text-blue-600 mt-1">0.00</p>
                        </div>
                    </div>

                    <!-- Chart Canvas -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pt-4">
                        <div class="bg-white p-6 rounded-xl shadow-xl border border-emerald-100">
                            <h3 class="text-lg font-semibold text-emerald-700 mb-4">‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
                            <canvas id="income-chart"></canvas>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-xl border border-emerald-100">
                            <h3 class="text-lg font-semibold text-red-700 mb-4">‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
                            <canvas id="expense-chart"></canvas>
                        </div>
                    </div>

                </div>

            </div> <!-- End of summary-view -->
            
            <!-- Dashboard View -->
            <div id="dashboard-view" class="space-y-8 pt-4 hidden">
                <h2 class="text-2xl font-bold text-emerald-800 border-b pb-2 mb-4 border-emerald-200">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>

                <!-- All-Time Totals -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-5 rounded-xl shadow-xl border-l-4 border-emerald-600">
                        <p class="text-sm text-gray-500">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤)</p>
                        <p id="dashboard-total-income" class="text-3xl font-extrabold text-emerald-700 mt-1">0.00</p>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-xl border-l-4 border-red-600">
                        <p class="text-sm text-gray-500">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤)</p>
                        <p id="dashboard-total-expense" class="text-3xl font-extrabold text-red-700 mt-1">0.00</p>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-xl border-l-4 border-blue-600">
                        <p class="text-sm text-gray-500">‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤)</p>
                        <p id="dashboard-net-balance" class="text-3xl font-extrabold text-blue-700 mt-1">0.00</p>
                    </div>
                </div>

                <!-- Monthly Trend Chart -->
                <div class="bg-white p-6 rounded-xl shadow-xl border border-emerald-100">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h3>
                    <canvas id="monthly-trend-chart"></canvas>
                </div>
                
                <!-- Top Categories -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pt-4">
                    <div class="bg-white p-6 rounded-xl shadow-xl border border-emerald-100">
                        <h3 class="text-lg font-semibold text-emerald-700 mb-4">Top 5 ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏° (‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤)</h3>
                        <ul id="top-income-list" class="space-y-2"></ul>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-xl border border-emerald-100">
                        <h3 class="text-lg font-semibold text-red-700 mb-4">Top 5 ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤)</h3>
                        <ul id="top-expense-list" class="space-y-2"></ul>
                    </div>
                </div>

            </div> <!-- End of dashboard-view -->
            
            <!-- Recent Records View (NEW DEDICATED TAB) -->
            <div id="records-view" class="space-y-8 pt-4 hidden">
                <div id="recent-records-section">
                    <h2 class="text-2xl font-bold text-emerald-800 border-b pb-2 mb-4 border-emerald-200">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
                    <div id="loading-spinner" class="text-center p-8 hidden">
                        <svg class="animate-spin h-8 w-8 text-emerald-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-2 text-emerald-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                    <div id="records-list" class="space-y-3">
                        <!-- Records will be injected here -->
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- JavaScript Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginScreen = document.getElementById('login-screen');
            const mainApp = document.getElementById('main-app');
            const recordForm = document.getElementById('record-form');
            const typeSelect = document.getElementById('type');
            const categorySelect = document.getElementById('category');
            const datetimeInput = document.getElementById('datetime-input');
            const recordsList = document.getElementById('records-list');
            const loadingSpinner = document.getElementById('loading-spinner');
            const saveButton = document.getElementById('save-button');
            const summaryTitlePeriod = document.getElementById('summary-title-period');
            const monthSelectorContainer = document.getElementById('month-selector-container');
            const monthSelector = document.getElementById('month-selector');
            const yearSelectorContainer = document.getElementById('year-selector-container');
            const yearSelector = document.getElementById('year-selector');
            
            // New UI Elements
            const summaryView = document.getElementById('summary-view');
            const dashboardView = document.getElementById('dashboard-view');
            const recordsView = document.getElementById('records-view'); // NEW: Records View
            const tabSummary = document.getElementById('tab-summary');
            const tabDashboard = document.getElementById('tab-dashboard');
            const tabRecords = document.getElementById('tab-records'); // NEW: Records Tab
            const dashboardTotalIncome = document.getElementById('dashboard-total-income');
            const dashboardTotalExpense = document.getElementById('dashboard-total-expense');
            const dashboardNetBalance = document.getElementById('dashboard-net-balance');
            const topIncomeList = document.getElementById('top-income-list');
            const topExpenseList = document.getElementById('top-expense-list');


            Chart.register(ChartDataLabels);

            // --- 1. UTILITY FUNCTIONS ---

            /**
             * Formats a number as a Thai currency string.
             * @param {number} amount 
             * @returns {string}
             */
            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', minimumFractionDigits: 2 }).format(amount).replace('‡∏ø', '').trim() + ' ‡∏ö‡∏≤‡∏ó';
            };
            
            /**
             * Formats a date object into a readable Thai datetime string.
             * @param {string} isoString 
             * @returns {string}
             */
            const formatDateTime = (isoString) => {
                try {
                    const date = new Date(isoString);
                    return date.toLocaleString('th-TH', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                } catch (e) {
                    return '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏ß‡∏•‡∏≤';
                }
            };
            
            /**
             * Converts a JavaScript Date object to the required format for datetime-local input
             * @param {Date} date 
             * @returns {string}
             */
            const toDateTimeLocal = (date) => {
                const pad = (num) => (num < 10 ? '0' : '') + num;
                return date.getFullYear() + '-' +
                    pad(date.getMonth() + 1) + '-' +
                    pad(date.getDate()) + 'T' +
                    pad(date.getHours()) + ':' +
                    pad(date.getMinutes());
            };
            
            /**
             * Creates a Date object from a serial number (e.g., from Google Sheets).
             * @param {number} serial 
             * @returns {Date}
             */
            const serialToDate = (serial) => {
                // Google Sheets serial day 1 is Dec 30, 1899
                const date = new Date(Date.UTC(1899, 11, 30));
                date.setUTCDate(date.getUTCDate() + serial);
                return date;
            }

            /**
             * Switches between Summary, Dashboard, and Records views. (UPDATED)
             * @param {string} viewId - 'summary', 'dashboard' or 'records'
             */
            window.showView = (viewId) => {
                currentView = viewId;
                
                // Reset tab classes
                tabSummary.classList.remove('active-main-tab');
                tabDashboard.classList.remove('active-main-tab');
                tabRecords.classList.remove('active-main-tab'); // New tab reset

                // Hide all views
                summaryView.classList.add('hidden');
                dashboardView.classList.add('hidden');
                recordsView.classList.add('hidden'); // New view hide

                // Show active view and update tab class
                if (viewId === 'summary') {
                    tabSummary.classList.add('active-main-tab');
                    summaryView.classList.remove('hidden');
                    updateAllSummaries(); 
                } else if (viewId === 'dashboard') {
                    tabDashboard.classList.add('active-main-tab');
                    dashboardView.classList.remove('hidden');
                    updateDashboard(); 
                } else if (viewId === 'records') {
                    tabRecords.classList.add('active-main-tab');
                    recordsView.classList.remove('hidden');
                    renderRecords(); // Ensure records are rendered/updated
                }
            };


            // --- 2. GAS COMMUNICATION (JSONP) ---
            
            /**
             * Sends a request to Google App Script using JSONP.
             * @param {object} params - Request parameters (including action).
             * @returns {Promise<object>} - Resolves with the data from GAS.
             */
            const gasRequest = (params) => {
                return new Promise((resolve, reject) => {
                    const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                    
                    window[callbackName] = (data) => {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        resolve(data);
                    };

                    const url = new URL(GAS_URL);
                    url.searchParams.set('callback', callbackName);
                    
                    // Add all other parameters
                    for (const key in params) {
                        // Ensure all data is stringified for safe URL transport, especially objects/arrays
                        url.searchParams.set(key, typeof params[key] === 'object' ? JSON.stringify(params[key]) : params[key]);
                    }

                    const script = document.createElement('script');
                    script.src = url.toString();
                    document.body.appendChild(script);

                    script.onerror = (e) => {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        reject(new Error("GAS Request failed or timed out."));
                    };
                });
            };
            
            /**
             * Retries the GAS request with exponential backoff.
             */
            const retryGasRequest = async (params, maxRetries = 3) => {
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        return await gasRequest(params);
                    } catch (error) {
                        if (i === maxRetries - 1) {
                            throw error; // Throw on final failure
                        }
                        const delay = Math.pow(2, i) * 1000;
                        console.warn(`Request failed, retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            };
            
            /**
             * Loads all data from Google Sheets.
             */
            const loadRecords = async () => {
                loadingSpinner.classList.remove('hidden');
                recordsList.innerHTML = '';
                
                try {
                    const result = await retryGasRequest({ action: 'load' });
                    
                    if (result && result.status === 'success' && Array.isArray(result.data)) {
                        // Header: ID, Timestamp, Type, Category, Amount, Date, User, EditTimestamp
                        const header = ['ID', 'Timestamp', 'Type', 'Category', 'Amount', 'Date', 'User', 'EditTimestamp'];
                        
                        records = result.data.slice(1) // Skip header row
                            .map(row => {
                                const record = {};
                                header.forEach((key, index) => {
                                    record[key] = row[index]; 
                                });
                                // Convert Sheets serial number to ISO string for easier JS use
                                if (typeof record.Date === 'number' && record.Date > 1) {
                                    record.Date = serialToDate(record.Date).toISOString();
                                }
                                // Ensure Timestamp is a string for easier JS use
                                if (typeof record.Timestamp === 'number' && record.Timestamp > 1) {
                                    record.Timestamp = serialToDate(record.Timestamp).toISOString();
                                }
                                return record;
                            })
                            // Sort by original date (newest first for most tasks, but we'll use Timestamp for list)
                            .sort((a, b) => new Date(b.Timestamp).getTime() - new Date(a.Timestamp).getTime());
                            
                        populateMonthSelector(); 
                        populateYearSelector(); 
                        
                        // Update the relevant view based on where the user currently is
                        if (currentView === 'summary') {
                            updateAllSummaries();
                        } else if (currentView === 'dashboard') {
                            updateDashboard();
                        } else if (currentView === 'records') {
                            renderRecords();
                        }
                        
                        Swal.close(); 
                        return;
                    }
                    
                    Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + (result ? result.message : '‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'), 'error');
                } catch (error) {
                    console.error('Error loading records:', error);
                    Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ' + error.message, 'error');
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            };

            // --- 3. AUTHENTICATION ---

            /**
             * Handles the login process.
             */
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                
                const user = USERS.find(u => u.name === username && u.password === password);
                
                if (user) {
                    localStorage.setItem('currentUser', user.name);
                    isLoggedIn = true;
                    document.getElementById('current-user').textContent = user.name;
                    loginScreen.classList.add('opacity-0');
                    setTimeout(() => {
                        loginScreen.classList.add('hidden');
                        mainApp.classList.remove('hidden');
                        // Load data and set initial time
                        datetimeInput.value = toDateTimeLocal(new Date());
                        loadRecords();
                    }, 500);
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß',
                        text: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
                    });
                }
            });
            
            /**
             * Logs the user out.
             */
            window.logout = () => {
                localStorage.removeItem('currentUser');
                isLoggedIn = false;
                records = [];
                mainApp.classList.add('hidden');
                loginScreen.classList.remove('hidden', 'opacity-0');
                // Reset state on logout
                currentPeriod = 'daily'; 
                selectedMonthYear = '';
                selectedYear = new Date().getFullYear().toString();
                currentView = 'summary';
                tabSummary.classList.add('active-main-tab');
                tabDashboard.classList.remove('active-main-tab');
                tabRecords.classList.remove('active-main-tab');
            };

            // Check login status on load
            const initialUser = localStorage.getItem('currentUser');
            if (initialUser && USERS.some(u => u.name === initialUser)) {
                isLoggedIn = true;
                document.getElementById('current-user').textContent = initialUser;
                loginScreen.classList.add('hidden', 'opacity-0');
                mainApp.classList.remove('hidden');
                datetimeInput.value = toDateTimeLocal(new Date());
                loadRecords();
            } else {
                loginScreen.classList.remove('hidden');
            }


            // --- 4. FORM LOGIC & RECORD MANAGEMENT ---

            /**
             * Updates the category dropdown based on the selected type (‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢).
             */
            typeSelect.addEventListener('change', () => {
                const type = typeSelect.value;
                categorySelect.innerHTML = '<option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>';
                categorySelect.disabled = true;

                if (type && CATEGORIES[type]) {
                    CATEGORIES[type].forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        categorySelect.appendChild(option);
                    });
                    categorySelect.disabled = false;
                }
            });
            
            /**
             * Handles form submission for adding or editing a record.
             */
            recordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const id = document.getElementById('record-id').value;
                const type = typeSelect.value;
                const category = categorySelect.value;
                const amount = parseFloat(document.getElementById('amount').value);
                const date = datetimeInput.value;
                const user = localStorage.getItem('currentUser');
                
                if (isNaN(amount) || amount <= 0) {
                    Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0', 'warning');
                    return;
                }
                
                const action = id ? 'edit' : 'save';
                const buttonText = id ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç...' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                
                Swal.fire({
                    title: buttonText,
                    html: '‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Å‡∏±‡∏ö Google Sheets...',
                    didOpen: () => Swal.showLoading(),
                    allowOutsideClick: false
                });

                try {
                    const dataToSend = {
                        Type: type,
                        Category: category,
                        Amount: amount,
                        Date: date,
                        User: user,
                    };
                    
                    let result;
                    
                    if (action === 'edit') {
                        result = await retryGasRequest({ 
                            action: 'edit',
                            id: id,
                            data: dataToSend
                        });
                    } else {
                        result = await retryGasRequest({ 
                            action: 'save',
                            data: dataToSend
                        });
                    }

                    if (result && result.status === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                            text: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                            showConfirmButton: false,
                            timer: 1500
                        });
                        recordForm.reset();
                        document.getElementById('record-id').value = '';
                        saveButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
                        datetimeInput.value = toDateTimeLocal(new Date()); // Reset time
                        loadRecords(); // Reload data to show update
                    } else {
                        throw new Error(result ? result.message : '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô');
                    }
                } catch (error) {
                    console.error('GAS operation error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß',
                        text: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message
                    });
                }
            });

            /**
             * Sets the form fields for editing an existing record.
             * @param {object} record 
             */
            window.editRecord = (record) => {
                document.getElementById('record-id').value = record.ID;
                typeSelect.value = record.Type;
                
                // Manually trigger category update
                typeSelect.dispatchEvent(new Event('change'));
                categorySelect.value = record.Category;
                
                document.getElementById('amount').value = record.Amount;
                
                // Format the Sheets Date value (ISO string or serial) to datetime-local format
                let dateToEdit = new Date(record.Date);
                if (record.Date && typeof record.Date === 'number') {
                    dateToEdit = serialToDate(record.Date);
                }
                datetimeInput.value = toDateTimeLocal(dateToEdit);
                
                saveButton.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
                
                // Scroll to top of the form
                document.querySelector('.sticky').scrollIntoView({ behavior: 'smooth' });
            };
            
            /**
             * Deletes a record by ID.
             * @param {string} id 
             */
            window.deleteRecord = async (id) => {
                const record = records.find(r => r.ID === id);
                if (!record) return;

                const result = await Swal.fire({
                    title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                    html: `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: <br><strong>${record.Type} (${record.Category}) ${formatCurrency(record.Amount)}</strong>?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢!',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
                });
                
                if (result.isConfirmed) {
                    Swal.fire({
                        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...',
                        didOpen: () => Swal.showLoading(),
                        allowOutsideClick: false
                    });
                    
                    try {
                        const deleteResult = await retryGasRequest({ 
                            action: 'delete',
                            id: id
                        });

                        if (deleteResult && deleteResult.status === 'success') {
                            Swal.fire({
                                icon: 'success',
                                title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                                showConfirmButton: false,
                                timer: 1500
                            });
                            loadRecords(); // Reload data
                        } else {
                            throw new Error(deleteResult ? deleteResult.message : '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô');
                        }
                    } catch (error) {
                        console.error('Delete operation error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: '‡∏•‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß',
                            text: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message
                        });
                    }
                }
            };

            /**
             * Renders the list of records (only the last 100).
             */
            const renderRecords = () => {
                const recentRecords = records.slice(0, 100);
                
                if (recentRecords.length === 0) {
                    recordsList.innerHTML = '<p class="text-gray-500 text-center p-4 bg-white rounded-lg shadow-md">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>';
                    return;
                }

                recordsList.innerHTML = recentRecords.map(record => {
                    const isIncome = record.Type === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö';
                    const amountClass = isIncome ? 'text-emerald-600' : 'text-red-600';
                    const borderColor = isIncome ? 'border-emerald-400' : 'border-red-400';
                    const editTime = record.EditTimestamp ? formatDateTime(record.EditTimestamp) : '‡πÑ‡∏°‡πà‡∏°‡∏µ';

                    return `
                        <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 ${borderColor} transition duration-200 hover:shadow-xl">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-semibold text-gray-500">${record.Type}: ${record.Category}</p>
                                    <p class="text-xl font-extrabold ${amountClass} mt-1">${formatCurrency(record.Amount)}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="editRecord(${JSON.stringify(record).replace(/"/g, '&quot;')})" class="text-blue-500 hover:text-blue-700 p-2 rounded-full hover:bg-blue-50 transition duration-150">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-3.646 3.646l-4.243 4.243V16h4.243l4.243-4.243-4.243-4.243z" /></svg>
                                    </button>
                                    <button onclick="deleteRecord('${record.ID}')" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition duration-150">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="text-xs text-gray-400 mt-2 border-t pt-2 border-gray-100">
                                <p>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatDateTime(record.Date)}</p>
                                <p>‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${record.User || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö'}</p>
                                <p>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${editTime}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            };

            /**
             * Populates the month selector dropdown based on existing record dates.
             */
            const populateMonthSelector = () => {
                monthSelector.innerHTML = '';
                
                if (records.length === 0) {
                    const now = new Date();
                    const currentMonthKey = now.getFullYear() + '-' + (now.getMonth() + 1).toString().padStart(2, '0');
                    monthSelector.innerHTML = `<option value="${currentMonthKey}">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${now.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' })}</option>`;
                    selectedMonthYear = currentMonthKey;
                    return;
                }

                // 1. Find the earliest record date
                const dates = records.map(r => new Date(r.Date).getTime()).filter(t => !isNaN(t));
                if (dates.length === 0) return;
                
                const minTime = Math.min(...dates);
                let startDate = new Date(minTime);
                startDate.setDate(1); 
                startDate.setHours(0, 0, 0, 0);

                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                
                // 2. Generate month list from earliest to current
                const months = [];
                let loopDate = new Date(startDate);

                while (loopDate.getFullYear() < currentYear || (loopDate.getFullYear() === currentYear && loopDate.getMonth() <= currentMonth)) {
                    const year = loopDate.getFullYear();
                    const month = loopDate.getMonth() + 1; // JS month is 0-11
                    const key = year + '-' + month.toString().padStart(2, '0');
                    const display = `‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${loopDate.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' })}`;

                    months.push({ key, display });

                    // Move to the next month
                    loopDate.setMonth(loopDate.getMonth() + 1);
                }
                
                // Reverse the list so the newest month is at the top
                months.reverse().forEach(month => {
                    const option = document.createElement('option');
                    option.value = month.key;
                    option.textContent = month.display;
                    monthSelector.appendChild(option);
                });

                // Set the initial selected month to the newest one and update state
                selectedMonthYear = months[0] ? months[0].key : (today.getFullYear() + '-' + (today.getMonth() + 1).toString().padStart(2, '0'));
                monthSelector.value = selectedMonthYear;
            };
            
            /**
             * Populates the year selector dropdown based on existing record dates.
             */
            const populateYearSelector = () => {
                yearSelector.innerHTML = '';
                
                const years = new Set();
                const nowYear = new Date().getFullYear();

                if (records.length === 0) {
                    years.add(nowYear);
                } else {
                    records.forEach(record => {
                        const date = new Date(record.Date);
                        if (!isNaN(date)) {
                            years.add(date.getFullYear());
                        }
                    });
                    // Ensure the current year is included if no records exist for it yet
                    years.add(nowYear);
                }

                // Convert Set to Array, sort descending (newest year first)
                const sortedYears = Array.from(years).sort((a, b) => b - a);
                
                sortedYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year.toString();
                    option.textContent = `‡∏õ‡∏µ ${year}`;
                    yearSelector.appendChild(option);
                });

                // Set the initial selected year and update state
                selectedYear = sortedYears[0] ? sortedYears[0].toString() : nowYear.toString();
                yearSelector.value = selectedYear;
            };


            // --- 5. SUMMARY LOGIC ---

            /**
             * Filters records based on the selected time period.
             */
            const filterRecords = (period, monthYear = '', year = '') => {
                const now = new Date();
                return records.filter(record => {
                    const recordDate = new Date(record.Date);
                    
                    if (period === 'daily') {
                        return recordDate.toDateString() === now.toDateString();
                    }
                    
                    if (period === 'weekly') {
                        const day = now.getDay(); // 0 is Sunday, 1 is Monday
                        const diff = now.getDate() - day + (day === 0 ? -6 : 1); 
                        
                        const startOfWeek = new Date(now.getFullYear(), now.getMonth(), diff);
                        startOfWeek.setHours(0, 0, 0, 0);
                        
                        const endOfWeek = new Date(startOfWeek);
                        endOfWeek.setDate(startOfWeek.getDate() + 7);

                        return recordDate >= startOfWeek && recordDate < endOfWeek;
                    }
                    
                    if (period === 'monthly') {
                        // Use the passed monthYear (e.g., '2023-11')
                        if (!monthYear) {
                            monthYear = now.getFullYear() + '-' + (now.getMonth() + 1).toString().padStart(2, '0');
                        }
                        const [targetYear, targetMonth] = monthYear.split('-').map(Number);
                        const jsMonth = targetMonth - 1; // JS month is 0-11

                        return recordDate.getFullYear() === targetYear && recordDate.getMonth() === jsMonth;
                    }
                    
                    if (period === 'yearly') {
                        const targetYear = year ? parseInt(year) : now.getFullYear();
                        return recordDate.getFullYear() === targetYear;
                    }
                    
                    return true;
                });
            };

            /**
             * Formats the period title text based on the filter.
             */
            const updateSummaryTitle = (period, monthYear = '', year = '') => {
                const now = new Date();
                let titleText = '';
                const optionsDate = { month: 'long', day: 'numeric', year: 'numeric' };
                const optionsMonth = { month: 'long', year: 'numeric' };

                if (period === 'daily') {
                    titleText = `‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${now.toLocaleDateString('th-TH', optionsDate)}`;
                } else if (period === 'weekly') {
                    const today = new Date();
                    const day = today.getDay(); 
                    const diff = today.getDate() - day + (day === 0 ? -6 : 1); 
                    const startOfWeek = new Date(today.getFullYear(), today.getMonth(), diff);
                    startOfWeek.setHours(0, 0, 0, 0);

                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);

                    const startStr = startOfWeek.toLocaleDateString('th-TH', { month: 'short', day: 'numeric' });
                    const endStr = endOfWeek.toLocaleDateString('th-TH', optionsDate);

                    titleText = `‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå: ${startStr} - ${endStr}`;

                } else if (period === 'monthly') {
                    if (monthYear) {
                        const [y, m] = monthYear.split('-');
                        const date = new Date(parseInt(y), parseInt(m) - 1, 1);
                        titleText = `‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${date.toLocaleDateString('th-TH', optionsMonth)}`;
                    } else {
                        titleText = `‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${now.toLocaleDateString('th-TH', optionsMonth)}`;
                    }
                } else if (period === 'yearly') {
                    const targetYear = year ? year : now.getFullYear(); 
                    titleText = `‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ ${targetYear}`;
                }
                
                summaryTitlePeriod.textContent = titleText;
            };

            
            /**
             * Aggregates filtered records into income and expense totals and category breakdowns.
             * @param {Array<object>} filteredRecords 
             * @returns {object} Aggregated data
             */
            const aggregateData = (filteredRecords) => {
                let totalIncome = 0;
                let totalExpense = 0;
                const incomeBreakdown = {};
                const expenseBreakdown = {};

                filteredRecords.forEach(record => {
                    const amount = parseFloat(record.Amount);
                    const category = record.Category;
                    
                    if (record.Type === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö') {
                        totalIncome += amount;
                        incomeBreakdown[category] = (incomeBreakdown[category] || 0) + amount;
                    } else if (record.Type === '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢') {
                        totalExpense += amount;
                        expenseBreakdown[category] = (expenseBreakdown[category] || 0) + amount;
                    }
                });

                return {
                    totalIncome,
                    totalExpense,
                    net: totalIncome - totalExpense,
                    incomeBreakdown,
                    expenseBreakdown
                };
            };
            
            /**
             * Renders or updates the Chart.js instances.
             */
            const renderChart = (chartId, breakdown) => {
                const ctx = document.getElementById(chartId).getContext('2d');
                
                const labels = Object.keys(breakdown).filter(key => breakdown[key] > 0);
                const data = labels.map(key => breakdown[key]);
                const backgroundColors = labels.map((_, i) => CHART_COLORS[i % CHART_COLORS.length]);

                if (allCharts[chartId]) {
                    allCharts[chartId].destroy();
                }

                allCharts[chartId] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors,
                            hoverOffset: 4,
                            borderWidth: 1,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        aspectRatio: 1,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    padding: 10,
                                    usePointStyle: true,
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += formatCurrency(context.parsed);
                                        return label;
                                    }
                                }
                            },
                            datalabels: {
                                color: '#fff',
                                textShadowColor: 'rgba(0,0,0,0.5)',
                                textShadowBlur: 4,
                                formatter: (value, context) => {
                                    const sum = context.dataset.data.reduce((a, b) => a + b, 0);
                                    if (sum === 0) return '';
                                    const percentage = (value * 100 / sum).toFixed(1) + "%";
                                    return percentage;
                                }
                            }
                        }
                    }
                });
            };
            
            /**
             * Main function to update all summary components based on the active period.
             * @param {string} period - 'daily', 'weekly', 'monthly', 'yearly'
             * @param {string} [monthYear] - Optional 'YYYY-MM' string for monthly filter
             * @param {string} [year] - Optional 'YYYY' string for yearly filter
             */
            const updateSummary = (period, monthYear = '', year = '') => {
                const filtered = filterRecords(period, monthYear, year);
                const aggregated = aggregateData(filtered);
                
                // 1. Update Title with period context
                updateSummaryTitle(period, monthYear, year);

                // 2. Update Summary Cards (Summary View)
                document.getElementById('summary-income').textContent = formatCurrency(aggregated.totalIncome);
                document.getElementById('summary-expense').textContent = formatCurrency(aggregated.totalExpense);
                
                const netElement = document.getElementById('summary-net');
                netElement.textContent = formatCurrency(Math.abs(aggregated.net));
                netElement.classList.remove('text-blue-600', 'text-red-600', 'text-emerald-600');
                if (aggregated.net > 0) {
                    netElement.classList.add('text-emerald-600');
                } else if (aggregated.net < 0) {
                    netElement.classList.add('text-red-600');
                } else {
                    netElement.classList.add('text-blue-600');
                }
                
                // 3. Update Charts
                renderChart('income-chart', aggregated.incomeBreakdown);
                renderChart('expense-chart', aggregated.expenseBreakdown);
            };
            
            // Helper to get parameters and call updateSummary based on current state
            const updateAllSummaries = () => {
                let monthYear = '';
                let year = ''; 
                
                if (currentPeriod === 'monthly') {
                    monthYear = monthSelector.value || selectedMonthYear; 
                } else if (currentPeriod === 'yearly') {
                    year = yearSelector.value || selectedYear;
                }
                updateSummary(currentPeriod, monthYear, year);
            }

            // Event listener for summary tabs
            document.querySelectorAll('.time-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // 1. Update active class
                    document.querySelectorAll('.time-tab').forEach(t => t.classList.remove('active-tab'));
                    this.classList.add('active-tab');
                    
                    currentPeriod = this.dataset.period; // Update global state
                    
                    // Hide both selectors first
                    monthSelectorContainer.classList.add('hidden'); 
                    yearSelectorContainer.classList.add('hidden'); 

                    let updateYear = '';
                    let updateMonthYear = '';

                    // 2. Handle Selector Visibility and initial update
                    if (currentPeriod === 'monthly') {
                        monthSelectorContainer.classList.remove('hidden');
                        updateMonthYear = monthSelector.value;
                    } else if (currentPeriod === 'yearly') {
                        yearSelectorContainer.classList.remove('hidden');
                        updateYear = yearSelector.value;
                    }
                    
                    updateSummary(currentPeriod, updateMonthYear, updateYear);
                });
            });

            // Event listener for the month selector (Triggers when month is changed)
            monthSelector.addEventListener('change', function() {
                selectedMonthYear = this.value; // Update global state
                if (currentPeriod === 'monthly') {
                    updateSummary('monthly', selectedMonthYear);
                }
            });
            
            // Event listener for the year selector (Triggers when year is changed)
            yearSelector.addEventListener('change', function() {
                selectedYear = this.value; // Update global state
                if (currentPeriod === 'yearly') {
                    // Pass selectedYear, monthYear remains empty
                    updateSummary('yearly', '', selectedYear); 
                }
            });
            
            // --- 6. DASHBOARD LOGIC ---
            
            /**
             * Aggregates records by month for the monthly trend chart.
             */
            const calculateMonthlyTrends = () => {
                const monthlyData = {};
                
                records.forEach(record => {
                    const date = new Date(record.Date);
                    // Format key as YYYY-MM
                    const yearMonth = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    const amount = parseFloat(record.Amount);

                    if (!monthlyData[yearMonth]) {
                        monthlyData[yearMonth] = { income: 0, expense: 0, date: date };
                    }

                    if (record.Type === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö') {
                        monthlyData[yearMonth].income += amount;
                    } else if (record.Type === '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢') {
                        monthlyData[yearMonth].expense += amount;
                    }
                });

                // Convert to array and sort by date
                let sortedMonths = Object.keys(monthlyData)
                    .map(key => ({ 
                        key: key, 
                        income: monthlyData[key].income, 
                        expense: monthlyData[key].expense,
                        net: monthlyData[key].income - monthlyData[key].expense,
                        date: monthlyData[key].date
                    }))
                    .sort((a, b) => a.date.getTime() - b.date.getTime());
                
                // Limit to the last 12 months
                sortedMonths = sortedMonths.slice(-12);
                
                return sortedMonths;
            };

            /**
             * Renders the Monthly Trend Chart (Bar Chart).
             */
            const renderMonthlyTrendChart = (monthlyData) => {
                const chartId = 'monthly-trend-chart';
                const ctx = document.getElementById(chartId).getContext('2d');
                
                if (allCharts[chartId]) {
                    allCharts[chartId].destroy();
                }

                const labels = monthlyData.map(d => 
                    d.date.toLocaleString('th-TH', { year: '2-digit', month: 'short' })
                );
                
                const incomeData = monthlyData.map(d => d.income);
                const expenseData = monthlyData.map(d => d.expense);
                const netData = monthlyData.map(d => d.net);

                allCharts[chartId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (Income)',
                                data: incomeData,
                                backgroundColor: PRIMARY_COLOR,
                            },
                            {
                                label: '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (Expense)',
                                data: expenseData,
                                backgroundColor: SECONDARY_COLOR,
                            },
                            {
                                type: 'line',
                                label: '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Net)',
                                data: netData,
                                borderColor: '#3b82f6', // Blue for Net
                                borderWidth: 3,
                                fill: false,
                                yAxisID: 'y1', // Use the second Y-axis
                                pointRadius: 5,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        aspectRatio: 2,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)' },
                                ticks: { callback: (value) => value.toLocaleString() },
                                position: 'left',
                            },
                            y1: {
                                beginAtZero: true,
                                title: { display: true, text: '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏ö‡∏≤‡∏ó)' },
                                ticks: { callback: (value) => value.toLocaleString() },
                                position: 'right',
                                grid: { drawOnChartArea: false }, // Only draw grid lines for the main Y-axis
                            }
                        },
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += formatCurrency(context.parsed.y);
                                        return label;
                                    }
                                }
                            },
                            datalabels: { display: false } // Disable datalabels for clarity on trend chart
                        }
                    }
                });
            };
            
            /**
             * Renders the top 5 income/expense categories.
             */
            const renderTopCategories = (breakdown, listElement, type) => {
                listElement.innerHTML = '';
                
                // Convert breakdown object to array and sort
                const sortedCategories = Object.entries(breakdown)
                    .map(([category, amount]) => ({ category, amount }))
                    .sort((a, b) => b.amount - a.amount)
                    .slice(0, 5);
                
                if (sortedCategories.length === 0) {
                    listElement.innerHTML = `<li class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${type === 'income' ? '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' : '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'}</li>`;
                    return;
                }
                
                const total = sortedCategories.reduce((sum, item) => sum + item.amount, 0);
                const color = type === 'income' ? 'bg-emerald-100' : 'bg-red-100';
                const textColor = type === 'income' ? 'text-emerald-700' : 'text-red-700';

                sortedCategories.forEach((item, index) => {
                    const percentage = total > 0 ? ((item.amount / total) * 100).toFixed(1) : 0;
                    const width = percentage > 0 ? percentage : 0.5; // Minimum bar width

                    const listItem = document.createElement('li');
                    listItem.className = 'py-2 border-b border-gray-100';
                    listItem.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium text-gray-700">${index + 1}. ${item.category}</span>
                            <span class="text-sm font-bold ${textColor}">${formatCurrency(item.amount)}</span>
                        </div>
                        <div class="w-full ${color} rounded-full h-2.5">
                            <div class="${color.replace('-100', '-500')} h-2.5 rounded-full" style="width: ${width}%;"></div>
                        </div>
                    `;
                    listElement.appendChild(listItem);
                });
            };

            /**
             * Main function to update the Dashboard view.
             */
            const updateDashboard = () => {
                if (records.length === 0) {
                    // Reset dashboard if no records
                    dashboardTotalIncome.textContent = formatCurrency(0);
                    dashboardTotalExpense.textContent = formatCurrency(0);
                    dashboardNetBalance.textContent = formatCurrency(0);
                    if(allCharts['monthly-trend-chart']) allCharts['monthly-trend-chart'].destroy();
                    topIncomeList.innerHTML = `<li class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>`;
                    topExpenseList.innerHTML = `<li class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>`;
                    return;
                }
                
                // 1. All-Time Totals
                const aggregatedAllTime = aggregateData(records);
                dashboardTotalIncome.textContent = formatCurrency(aggregatedAllTime.totalIncome);
                dashboardTotalExpense.textContent = formatCurrency(aggregatedAllTime.totalExpense);
                
                dashboardNetBalance.textContent = formatCurrency(Math.abs(aggregatedAllTime.net));
                dashboardNetBalance.classList.remove('text-blue-700', 'text-red-700', 'text-emerald-700');
                if (aggregatedAllTime.net > 0) {
                    dashboardNetBalance.classList.add('text-emerald-700');
                } else if (aggregatedAllTime.net < 0) {
                    dashboardNetBalance.classList.add('text-red-700');
                } else {
                    dashboardNetBalance.classList.add('text-blue-700');
                }
                
                // 2. Monthly Trend Chart
                const monthlyTrends = calculateMonthlyTrends();
                renderMonthlyTrendChart(monthlyTrends);
                
                // 3. Top Categories
                renderTopCategories(aggregatedAllTime.incomeBreakdown, topIncomeList, 'income');
                renderTopCategories(aggregatedAllTime.expenseBreakdown, topExpenseList, 'expense');
            };
            
            // --- 7. INITIALIZATION ---

            // Show the default view on load (Summary)
            showView('summary');

        });
    </script>
</body>
</html>
